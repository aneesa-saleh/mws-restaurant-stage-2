"use strict";

var restaurant;
var newMap;
var matchesMediaQuery;
var mediaQuery = '(min-width: 800px)';
/**
 * Initialize map as soon as the page is loaded.
 */

document.addEventListener('DOMContentLoaded', function (event) {
  initMap();

  if (window.matchMedia) {
    matchesMediaQuery = window.matchMedia(mediaQuery).matches;
  }

  updateRestaurantContainerAria(); // set initial aria values

  registerServiceWorker();
});
/**
 * Initialize leaflet map
 */

var initMap = function initMap() {
  fetchRestaurantFromURL(function (error, restaurant) {
    var MAPBOX_API_KEY = 'pk.eyJ1IjoiYW5lZXNhLXNhbGVoIiwiYSI6ImNqa2xmZHVwMDFoYW4zdnAwYWplMm53bHEifQ.V11dDOtEnWSwTxY-C8mJLw';

    if (error) {
      // Got an error!
      console.error(error);
    } else {
      self.newMap = L.map('map', {
        center: [restaurant.latlng.lat, restaurant.latlng.lng],
        zoom: 16,
        scrollWheelZoom: false
      });
      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.jpg70?access_token={mapboxToken}', {
        mapboxToken: MAPBOX_API_KEY,
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' + '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox.streets'
      }).addTo(newMap);
      fillBreadcrumb();
      DBHelper.mapMarkerForRestaurant(self.restaurant, self.newMap);
    }
  });
};
/**
* Update aria-hidden values of the visible and accessible restaurant containers
*/


window.addEventListener('resize', function () {
  if (window.matchMedia) {
    var nextMatchesMediaQuery = window.matchMedia(mediaQuery).matches;

    if (nextMatchesMediaQuery !== matchesMediaQuery) {
      // only update aria when layout changes
      matchesMediaQuery = nextMatchesMediaQuery;
      updateRestaurantContainerAria();
    }
  }
});
/**
* Set aria-hidden values for visible and regular restaurant containers
* Accessible restaurant container is off screen
* It is required to maintain screen reading order when the layout shifts
*/

var updateRestaurantContainerAria = function updateRestaurantContainerAria() {
  var restaurantContainer = document.getElementById('restaurant-container');
  var accessibleRestaurantContainer = document.getElementById('accessible-restaurant-container');

  if (matchesMediaQuery) {
    // larger layout, screen reading order off
    restaurantContainer.setAttribute('aria-hidden', 'true');
    accessibleRestaurantContainer.setAttribute('aria-hidden', 'false');
  } else {
    // use regular reading order
    restaurantContainer.setAttribute('aria-hidden', 'false');
    accessibleRestaurantContainer.setAttribute('aria-hidden', 'true');
  }
};
/**
 * Get current restaurant from page URL.
 */


var fetchRestaurantFromURL = function fetchRestaurantFromURL(callback) {
  if (self.restaurant) {
    // restaurant already fetched!
    callback(null, self.restaurant);
    return;
  }

  var id = getParameterByName('id');

  if (!id) {
    // no id found in URL
    error = 'No restaurant id in URL';
    callback(error, null);
  } else {
    DBHelper.fetchRestaurantById(id, function (error, restaurant) {
      self.restaurant = restaurant;

      if (!restaurant) {
        console.error(error);
        return;
      }

      fillRestaurantHTML();
      callback(null, restaurant);
    });
  }
};
/**
 * Create restaurant HTML and add it to the webpage
 */


var fillRestaurantHTML = function fillRestaurantHTML() {
  var restaurant = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.restaurant;
  var name = document.getElementById('restaurant-name');
  name.innerHTML = restaurant.name;
  var address = document.getElementById('restaurant-address');
  address.innerHTML += restaurant.address;
  var picture = document.getElementById('restaurant-picture');
  var sourceLarge = document.createElement('source');
  sourceLarge.media = '(min-width: 800px)';
  sourceLarge.srcset = DBHelper.imageUrlForRestaurant(restaurant, {
    size: 'large',
    wide: true
  });
  sourceLarge.type = 'image/jpeg';
  picture.appendChild(sourceLarge);
  var sourceMedium = document.createElement('source');
  sourceMedium.media = '(min-width: 600px)';
  sourceMedium.srcset = DBHelper.imageUrlForRestaurant(restaurant, {
    size: 'medium'
  });
  sourceMedium.type = 'image/jpeg';
  picture.appendChild(sourceMedium);
  var sourceSmall = document.createElement('source');
  sourceSmall.srcset = DBHelper.imageUrlForRestaurant(restaurant, {
    size: 'small'
  });
  sourceSmall.type = 'image/jpeg';
  picture.appendChild(sourceSmall);
  var image = document.createElement('img');
  image.className = 'restaurant-img'; // set default size in case picture element is not supported

  image.src = DBHelper.imageUrlForRestaurant(restaurant);
  image.alt = restaurant.alt;
  picture.appendChild(image);
  var accessibleRestaurantImage = document.getElementById('accessible-restaurant-img');
  accessibleRestaurantImage.setAttribute('aria-label', restaurant.alt);
  var cuisine = document.getElementById('restaurant-cuisine');
  cuisine.innerHTML = "Cuisine: ".concat(restaurant.cuisine_type);
  var accessibleRestaurantCuisine = document.getElementById('accessible-restaurant-cuisine');
  accessibleRestaurantCuisine.innerHTML = "Cuisine: ".concat(restaurant.cuisine_type); // fill operating hours

  if (restaurant.operating_hours) {
    fillRestaurantHoursHTML();
  } // fill reviews


  fillReviewsHTML();
};
/**
 * Create restaurant operating hours HTML table and add it to the webpage.
 */


var fillRestaurantHoursHTML = function fillRestaurantHoursHTML() {
  var operatingHours = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.restaurant.operating_hours;
  var hours = document.getElementById('restaurant-hours');

  for (var key in operatingHours) {
    if (Object.prototype.hasOwnProperty.call(operatingHours, key)) {
      var row = document.createElement('tr');
      var day = document.createElement('td');
      day.innerHTML = key;
      row.appendChild(day);
      var time = document.createElement('td');
      time.innerHTML = operatingHours[key];
      row.appendChild(time);
      hours.appendChild(row);
    }
  }
};
/**
 * Create all reviews HTML and add them to the webpage.
 */


var fillReviewsHTML = function fillReviewsHTML() {
  var reviews = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.restaurant.reviews;
  var container = document.getElementById('reviews-container');
  var title = document.createElement('h2');
  title.innerHTML = 'Reviews';
  container.appendChild(title);

  if (!reviews) {
    var noReviews = document.createElement('p');
    noReviews.innerHTML = 'No reviews yet!';
    container.appendChild(noReviews);
    return;
  }

  var ul = document.getElementById('reviews-list');
  reviews.forEach(function (review) {
    ul.appendChild(createReviewHTML(review));
  });
  container.appendChild(ul);
};
/**
 * Create review HTML and add it to the webpage.
 */


var createReviewHTML = function createReviewHTML(review) {
  var article = document.createElement('article');
  article.className = 'review';
  var headerSpan = document.createElement('span');
  headerSpan.className = 'review-header';
  var name = document.createElement('p');
  name.innerHTML = review.name;
  name.className = 'review-name';
  headerSpan.appendChild(name);
  var date = document.createElement('p');
  date.innerHTML = review.date;
  date.className = 'review-date';
  headerSpan.appendChild(date);
  article.appendChild(headerSpan);
  var contentSpan = document.createElement('span');
  contentSpan.className = 'review-content';
  var rating = document.createElement('p');
  rating.innerHTML = "Rating: ".concat(review.rating);
  rating.className = 'review-rating';
  contentSpan.appendChild(rating);
  var comments = document.createElement('p');
  comments.innerHTML = review.comments;
  contentSpan.appendChild(comments);
  article.appendChild(contentSpan);
  return article;
};
/**
 * Add restaurant name to the breadcrumb navigation menu
 */


var fillBreadcrumb = function fillBreadcrumb() {
  var restaurant = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : self.restaurant;
  var breadcrumb = document.getElementById('breadcrumb');
  var li = document.createElement('li');
  li.innerHTML = restaurant.name;
  breadcrumb.appendChild(li);
};
/**
 * Get a parameter by name from page URL.
 */


var getParameterByName = function getParameterByName(name, url) {
  url = url || window.location.href;
  name = name.replace(/[\[\]]/g, '\\$&');
  var regex = new RegExp("[?&]".concat(name, "(=([^&#]*)|&|#|$)"));
  var results = regex.exec(url);
  if (!results) return null;
  if (!results[2]) return '';
  return decodeURIComponent(results[2].replace(/\+/g, ' '));
};

var registerServiceWorker = function registerServiceWorker() {
  if (!navigator.serviceWorker) return;
  navigator.serviceWorker.register('/service-worker.js').catch(function (error) {
    return console.log(error);
  });
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJlc3RhdXJhbnRfaW5mby5qcyJdLCJuYW1lcyI6WyJyZXN0YXVyYW50IiwibmV3TWFwIiwibWF0Y2hlc01lZGlhUXVlcnkiLCJtZWRpYVF1ZXJ5IiwiZG9jdW1lbnQiLCJhZGRFdmVudExpc3RlbmVyIiwiZXZlbnQiLCJpbml0TWFwIiwid2luZG93IiwibWF0Y2hNZWRpYSIsIm1hdGNoZXMiLCJ1cGRhdGVSZXN0YXVyYW50Q29udGFpbmVyQXJpYSIsInJlZ2lzdGVyU2VydmljZVdvcmtlciIsImZldGNoUmVzdGF1cmFudEZyb21VUkwiLCJlcnJvciIsIk1BUEJPWF9BUElfS0VZIiwiY29uc29sZSIsInNlbGYiLCJMIiwibWFwIiwiY2VudGVyIiwibGF0bG5nIiwibGF0IiwibG5nIiwiem9vbSIsInNjcm9sbFdoZWVsWm9vbSIsInRpbGVMYXllciIsIm1hcGJveFRva2VuIiwibWF4Wm9vbSIsImF0dHJpYnV0aW9uIiwiaWQiLCJhZGRUbyIsImZpbGxCcmVhZGNydW1iIiwiREJIZWxwZXIiLCJtYXBNYXJrZXJGb3JSZXN0YXVyYW50IiwibmV4dE1hdGNoZXNNZWRpYVF1ZXJ5IiwicmVzdGF1cmFudENvbnRhaW5lciIsImdldEVsZW1lbnRCeUlkIiwiYWNjZXNzaWJsZVJlc3RhdXJhbnRDb250YWluZXIiLCJzZXRBdHRyaWJ1dGUiLCJjYWxsYmFjayIsImdldFBhcmFtZXRlckJ5TmFtZSIsImZldGNoUmVzdGF1cmFudEJ5SWQiLCJmaWxsUmVzdGF1cmFudEhUTUwiLCJuYW1lIiwiaW5uZXJIVE1MIiwiYWRkcmVzcyIsInBpY3R1cmUiLCJzb3VyY2VMYXJnZSIsImNyZWF0ZUVsZW1lbnQiLCJtZWRpYSIsInNyY3NldCIsImltYWdlVXJsRm9yUmVzdGF1cmFudCIsInNpemUiLCJ3aWRlIiwidHlwZSIsImFwcGVuZENoaWxkIiwic291cmNlTWVkaXVtIiwic291cmNlU21hbGwiLCJpbWFnZSIsImNsYXNzTmFtZSIsInNyYyIsImFsdCIsImFjY2Vzc2libGVSZXN0YXVyYW50SW1hZ2UiLCJjdWlzaW5lIiwiY3Vpc2luZV90eXBlIiwiYWNjZXNzaWJsZVJlc3RhdXJhbnRDdWlzaW5lIiwib3BlcmF0aW5nX2hvdXJzIiwiZmlsbFJlc3RhdXJhbnRIb3Vyc0hUTUwiLCJmaWxsUmV2aWV3c0hUTUwiLCJvcGVyYXRpbmdIb3VycyIsImhvdXJzIiwia2V5IiwiT2JqZWN0IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwicm93IiwiZGF5IiwidGltZSIsInJldmlld3MiLCJjb250YWluZXIiLCJ0aXRsZSIsIm5vUmV2aWV3cyIsInVsIiwiZm9yRWFjaCIsInJldmlldyIsImNyZWF0ZVJldmlld0hUTUwiLCJhcnRpY2xlIiwiaGVhZGVyU3BhbiIsImRhdGUiLCJjb250ZW50U3BhbiIsInJhdGluZyIsImNvbW1lbnRzIiwiYnJlYWRjcnVtYiIsImxpIiwidXJsIiwibG9jYXRpb24iLCJocmVmIiwicmVwbGFjZSIsInJlZ2V4IiwiUmVnRXhwIiwicmVzdWx0cyIsImV4ZWMiLCJkZWNvZGVVUklDb21wb25lbnQiLCJuYXZpZ2F0b3IiLCJzZXJ2aWNlV29ya2VyIiwicmVnaXN0ZXIiLCJjYXRjaCIsImxvZyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJQSxVQUFKO0FBQ0EsSUFBSUMsTUFBSjtBQUNBLElBQUlDLGlCQUFKO0FBQ0EsSUFBTUMsVUFBVSxHQUFHLG9CQUFuQjtBQUVBOzs7O0FBR0FDLFFBQVEsQ0FBQ0MsZ0JBQVQsQ0FBMEIsa0JBQTFCLEVBQThDLFVBQUNDLEtBQUQsRUFBVztBQUN2REMsRUFBQUEsT0FBTzs7QUFDUCxNQUFJQyxNQUFNLENBQUNDLFVBQVgsRUFBdUI7QUFDckJQLElBQUFBLGlCQUFpQixHQUFHTSxNQUFNLENBQUNDLFVBQVAsQ0FBa0JOLFVBQWxCLEVBQThCTyxPQUFsRDtBQUNEOztBQUNEQyxFQUFBQSw2QkFBNkIsR0FMMEIsQ0FLdEI7O0FBQ2pDQyxFQUFBQSxxQkFBcUI7QUFDdEIsQ0FQRDtBQVNBOzs7O0FBR0EsSUFBTUws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QUFrQixHQUFHLFNBQXJCQSxrQkFBcUIsQ0FBQ0csSUFBRCxFQUFPb0QsR0FBUCxFQUFlO0FBQ3hDQSxFQUFBQSxHQUFHLEdBQUdBLEdBQUcsSUFBSXhGLE1BQU0sQ0FBQ3lGLFFBQVAsQ0FBZ0JDLElBQTdCO0FBQ0F0RCxFQUFBQSxJQUFJLEdBQUdBLElBQUksQ0FBQ3VELE9BQUwsQ0FBYSxTQUFiLEVBQXdCLE1BQXhCLENBQVA7QUFDQSxNQUFNQyxLQUFLLEdBQUcsSUFBSUMsTUFBSixlQUFrQnpELElBQWxCLHVCQUFkO0FBR0EsTUFBTTBELE9BQU8sR0FBR0YsS0FBSyxDQUFDRyxJQUFOLENBQVdQLEdBQVgsQ0FBaEI7QUFDQSxNQUFJLENBQUNNLE9BQUwsRUFBYyxPQUFPLElBQVA7QUFDZCxNQUFJLENBQUNBLE9BQU8sQ0FBQyxDQUFELENBQVosRUFBaUIsT0FBTyxFQUFQO0FBQ2pCLFNBQU9FLGtCQUFrQixDQUFDRixPQUFPLENBQUMsQ0FBRCxDQUFQLENBQVdILE9BQVgsQ0FBbUIsS0FBbkIsRUFBMEIsR0FBMUIsQ0FBRCxDQUF6QjtBQUNELENBVkQ7O0FBWUEsSUFBTXZGLHFCQUFxQixHQUFHLFNBQXhCQSxxQkFBd0IsR0FBTTtBQUNsQyxNQUFJLENBQUM2RixTQUFTLENBQUNDLGFBQWYsRUFBOEI7QUFFOUJELEVBQUFBLFNBQVMsQ0FBQ0MsYUFBVixDQUF3QkMsUUFBeEIsQ0FBaUMsb0JBQWpDLEVBQ0dDLEtBREgsQ0FDUyxVQUFBOUYsS0FBSztBQUFBLFdBQUlFLE9BQU8sQ0FBQzZGLEdBQVIsQ0FBWS9GLEtBQVosQ0FBSjtBQUFBLEdBRGQ7QUFFRCxDQUxEIiwic291cmNlc0NvbnRlbnQiOlsibGV0IHJlc3RhdXJhbnQ7XG52YXIgbmV3TWFwO1xubGV0IG1hdGNoZXNNZWRpYVF1ZXJ5O1xuY29uc3QgbWVkaWFRdWVyeSA9ICcobWluLXdpZHRoOiA4MDBweCknO1xuXG4vKipcbiAqIEluaXRpYWxpemUgbWFwIGFzIHNvb24gYXMgdGhlIHBhZ2UgaXMgbG9hZGVkLlxuICovXG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgKGV2ZW50KSA9PiB7XG4gIGluaXRNYXAoKTtcbiAgaWYgKHdpbmRvdy5tYXRjaE1lZGlhKSB7XG4gICAgbWF0Y2hlc01lZGlhUXVlcnkgPSB3aW5kb3cubWF0Y2hNZWRpYShtZWRpYVF1ZXJ5KS5tYXRjaGVzO1xuICB9XG4gIHVwZGF0ZVJlc3RhdXJhbnRDb250YWluZXJBcmlhKCk7IC8vIHNldCBpbml0aWFsIGFyaWEgdmFsdWVzXG4gIHJlZ2lzdGVyU2VydmljZVdvcmtlcigpO1xufSk7XG5cbi8qKlxuICogSW5pdGlhbGl6ZSBsZWFmbGV0IG1hcFxuICovXG5jb25zdCBpbml0TWFwID0gKCkgPT4ge1xuICBmZXRjaFJlc3RhdXJhbnRGcm9tVVJMKChlcnJvciwgcmVzdGF1cmFudCkgPT4ge1xuICAgIGNvbnN0IE1BUEJPWF9BUElfS0VZID0gJ3BrLmV5SjFJam9pWVc1bFpYTmhMWE5oYkdWb0lpd2lZU0k2SW1OcWEyeG1aSFZ3TURGb1lXNHpkbkF3WVdwbE1tNTNiSEVpZlEuVjExZERPdEVuV1N3VHhZLUM4bUpMdyc7XG4gICAgaWYgKGVycm9yKSB7IC8vIEdvdCBhbiBlcnJvciFcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZWxmLm5ld01hcCA9IEwubWFwKCdtYXAnLCB7XG4gICAgICAgIGNlbnRlcjogW3Jlc3RhdXJhbnQubGF0bG5nLmxhdCwgcmVzdGF1cmFudC5sYXRsbmcubG5nXSxcbiAgICAgICAgem9vbTogMTYsXG4gICAgICAgIHNjcm9sbFdoZWVsWm9vbTogZmFsc2UsXG4gICAgICB9KTtcbiAgICAgIEwudGlsZUxheWVyKCdodHRwczovL2FwaS50aWxlcy5tYXBib3guY29tL3Y0L3tpZH0ve3p9L3t4fS97eX0uanBnNzA/YWNjZXNzX3Rva2VuPXttYXBib3hUb2tlbn0nLCB7XG4gICAgICAgIG1hcGJveFRva2VuOiBNQVBCT1hfQVBJX0tFWSxcbiAgICAgICAgbWF4Wm9vbTogMTgsXG4gICAgICAgIGF0dHJpYnV0aW9uOiAnTWFwIGRhdGEgJmNvcHk7IDxhIGhyZWY9XCJodHRwczovL3d3dy5vcGVuc3RyZWV0bWFwLm9yZy9cIj5PcGVuU3RyZWV0TWFwPC9hPiBjb250cmlidXRvcnMsICdcbiAgICAgICAgICArICc8YSBocmVmPVwiaHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LXNhLzIuMC9cIj5DQy1CWS1TQTwvYT4sICdcbiAgICAgICAgICArICdJbWFnZXJ5IMKpIDxhIGhyZWY9XCJodHRwczovL3d3dy5tYXBib3guY29tL1wiPk1hcGJveDwvYT4nLFxuICAgICAgICBpZDogJ21hcGJveC5zdHJlZXRzJyxcbiAgICAgIH0pLmFkZFRvKG5ld01hcCk7XG4gICAgICBmaWxsQnJlYWRjcnVtYigpO1xuICAgICAgREJIZWxwZXIubWFwTWFya2VyRm9yUmVzdGF1cmFudChzZWxmLnJlc3RhdXJhbnQsIHNlbGYubmV3TWFwKTtcbiAgICB9XG4gIH0pO1xufTtcblxuLyoqXG4qIFVwZGF0ZSBhcmlhLWhpZGRlbiB2YWx1ZXMgb2YgdGhlIHZpc2libGUgYW5kIGFjY2Vzc2libGUgcmVzdGF1cmFudCBjb250YWluZXJzXG4qL1xud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsICgpID0+IHtcbiAgaWYgKHdpbmRvdy5tYXRjaE1lZGlhKSB7XG4gICAgY29uc3QgbmV4dE1hdGNoZXNNZWRpYVF1ZXJ5ID0gd2luZG93Lm1hdGNoTWVkaWEobWVkaWFRdWVyeSkubWF0Y2hlcztcbiAgICBpZiAobmV4dE1hdGNoZXNNZWRpYVF1ZXJ5ICE9PSBtYXRjaGVzTWVkaWFRdWVyeSkgeyAvLyBvbmx5IHVwZGF0ZSBhcmlhIHdoZW4gbGF5b3V0IGNoYW5nZXNcbiAgICAgIG1hdGNoZXNNZWRpYVF1ZXJ5ID0gbmV4dE1hdGNoZXNNZWRpYVF1ZXJ5O1xuICAgICAgdXBkYXRlUmVzdGF1cmFudENvbnRhaW5lckFyaWEoKTtcbiAgICB9XG4gIH1cbn0pO1xuXG4vKipcbiogU2V0IGFyaWEtaGlkZGVuIHZhbHVlcyBmb3IgdmlzaWJsZSBhbmQgcmVndWxhciByZXN0YXVyYW50IGNvbnRhaW5lcnNcbiogQWNjZXNzaWJsZSByZXN0YXVyYW50IGNvbnRhaW5lciBpcyBvZmYgc2NyZWVuXG4qIEl0IGlzIHJlcXVpcmVkIHRvIG1haW50YWluIHNjcmVlbiByZWFkaW5nIG9yZGVyIHdoZW4gdGhlIGxheW91dCBzaGlmdHNcbiovXG5jb25zdCB1cGRhdGVSZXN0YXVyYW50Q29udGFpbmVyQXJpYSA9ICgpID0+IHtcbiAgY29uc3QgcmVzdGF1cmFudENvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50LWNvbnRhaW5lcicpO1xuICBjb25zdCBhY2Nlc3NpYmxlUmVzdGF1cmFudENvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY2Nlc3NpYmxlLXJlc3RhdXJhbnQtY29udGFpbmVyJyk7XG4gIGlmIChtYXRjaGVzTWVkaWFRdWVyeSkgeyAvLyBsYXJnZXIgbGF5b3V0LCBzY3JlZW4gcmVhZGluZyBvcmRlciBvZmZcbiAgICByZXN0YXVyYW50Q29udGFpbmVyLnNldEF0dHJpYnV0ZSgnYXJpYS1oaWRkZW4nLCAndHJ1ZScpO1xuICAgIGFjY2Vzc2libGVSZXN0YXVyYW50Q29udGFpbmVyLnNldEF0dHJpYnV0ZSgnYXJpYS1oaWRkZW4nLCAnZmFsc2UnKTtcbiAgfSBlbHNlIHsgLy8gdXNlIHJlZ3VsYXIgcmVhZGluZyBvcmRlclxuICAgIHJlc3RhdXJhbnRDb250YWluZXIuc2V0QXR0cmlidXRlKCdhcmlhLWhpZGRlbicsICdmYWxzZScpO1xuICAgIGFjY2Vzc2libGVSZXN0YXVyYW50Q29udGFpbmVyLnNldEF0dHJpYnV0ZSgnYXJpYS1oaWRkZW4nLCAndHJ1ZScpO1xuICB9XG59O1xuXG4vKipcbiAqIEdldCBjdXJyZW50IHJlc3RhdXJhbnQgZnJvbSBwYWdlIFVSTC5cbiAqL1xuY29uc3QgZmV0Y2hSZXN0YXVyYW50RnJvbVVSTCA9IChjYWxsYmFjaykgPT4ge1xuICBpZiAoc2VsZi5yZXN0YXVyYW50KSB7IC8vIHJlc3RhdXJhbnQgYWxyZWFkeSBmZXRjaGVkIVxuICAgIGNhbGxiYWNrKG51bGwsIHNlbGYucmVzdGF1cmFudCk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IGlkID0gZ2V0UGFyYW1ldGVyQnlOYW1lKCdpZCcpO1xuICBpZiAoIWlkKSB7IC8vIG5vIGlkIGZvdW5kIGluIFVSTFxuICAgIGVycm9yID0gJ05vIHJlc3RhdXJhbnQgaWQgaW4gVVJMJztcbiAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XG4gIH0gZWxzZSB7XG4gICAgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50QnlJZChpZCwgKGVycm9yLCByZXN0YXVyYW50KSA9PiB7XG4gICAgICBzZWxmLnJlc3RhdXJhbnQgPSByZXN0YXVyYW50O1xuICAgICAgaWYgKCFyZXN0YXVyYW50KSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBmaWxsUmVzdGF1cmFudEhUTUwoKTtcbiAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3RhdXJhbnQpO1xuICAgIH0pO1xuICB9XG59O1xuXG4vKipcbiAqIENyZWF0ZSByZXN0YXVyYW50IEhUTUwgYW5kIGFkZCBpdCB0byB0aGUgd2VicGFnZVxuICovXG5jb25zdCBmaWxsUmVzdGF1cmFudEhUTUwgPSAocmVzdGF1cmFudCA9IHNlbGYucmVzdGF1cmFudCkgPT4ge1xuICBjb25zdCBuYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtbmFtZScpO1xuICBuYW1lLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmFtZTtcblxuICBjb25zdCBhZGRyZXNzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnQtYWRkcmVzcycpO1xuICBhZGRyZXNzLmlubmVySFRNTCArPSByZXN0YXVyYW50LmFkZHJlc3M7XG5cbiAgY29uc3QgcGljdHVyZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50LXBpY3R1cmUnKTtcblxuICBjb25zdCBzb3VyY2VMYXJnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NvdXJjZScpO1xuICBzb3VyY2VMYXJnZS5tZWRpYSA9ICcobWluLXdpZHRoOiA4MDBweCknO1xuICBzb3VyY2VMYXJnZS5zcmNzZXQgPSBEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCwgeyBzaXplOiAnbGFyZ2UnLCB3aWRlOiB0cnVlIH0pO1xuICBzb3VyY2VMYXJnZS50eXBlID0gJ2ltYWdlL2pwZWcnO1xuICBwaWN0dXJlLmFwcGVuZENoaWxkKHNvdXJjZUxhcmdlKTtcblxuICBjb25zdCBzb3VyY2VNZWRpdW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzb3VyY2UnKTtcbiAgc291cmNlTWVkaXVtLm1lZGlhID0gJyhtaW4td2lkdGg6IDYwMHB4KSc7XG4gIHNvdXJjZU1lZGl1bS5zcmNzZXQgPSBEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCwgeyBzaXplOiAnbWVkaXVtJyB9KTtcbiAgc291cmNlTWVkaXVtLnR5cGUgPSAnaW1hZ2UvanBlZyc7XG4gIHBpY3R1cmUuYXBwZW5kQ2hpbGQoc291cmNlTWVkaXVtKTtcblxuICBjb25zdCBzb3VyY2VTbWFsbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NvdXJjZScpO1xuICBzb3VyY2VTbWFsbC5zcmNzZXQgPSBEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCwgeyBzaXplOiAnc21hbGwnIH0pO1xuICBzb3VyY2VTbWFsbC50eXBlID0gJ2ltYWdlL2pwZWcnO1xuICBwaWN0dXJlLmFwcGVuZENoaWxkKHNvdXJjZVNtYWxsKTtcblxuICBjb25zdCBpbWFnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpO1xuICBpbWFnZS5jbGFzc05hbWUgPSAncmVzdGF1cmFudC1pbWcnO1xuICAvLyBzZXQgZGVmYXVsdCBzaXplIGluIGNhc2UgcGljdHVyZSBlbGVtZW50IGlzIG5vdCBzdXBwb3J0ZWRcbiAgaW1hZ2Uuc3JjID0gREJIZWxwZXIuaW1hZ2VVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpO1xuICBpbWFnZS5hbHQgPSByZXN0YXVyYW50LmFsdDtcbiAgcGljdHVyZS5hcHBlbmRDaGlsZChpbWFnZSk7XG5cbiAgY29uc3QgYWNjZXNzaWJsZVJlc3RhdXJhbnRJbWFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY2Nlc3NpYmxlLXJlc3RhdXJhbnQtaW1nJyk7XG4gIGFjY2Vzc2libGVSZXN0YXVyYW50SW1hZ2Uuc2V0QXR0cmlidXRlKCdhcmlhLWxhYmVsJywgcmVzdGF1cmFudC5hbHQpO1xuXG4gIGNvbnN0IGN1aXNpbmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVzdGF1cmFudC1jdWlzaW5lJyk7XG4gIGN1aXNpbmUuaW5uZXJIVE1MID0gYEN1aXNpbmU6ICR7cmVzdGF1cmFudC5jdWlzaW5lX3R5cGV9YDtcblxuICBjb25zdCBhY2Nlc3NpYmxlUmVzdGF1cmFudEN1aXNpbmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWNjZXNzaWJsZS1yZXN0YXVyYW50LWN1aXNpbmUnKTtcbiAgYWNjZXNzaWJsZVJlc3RhdXJhbnRDdWlzaW5lLmlubmVySFRNTCA9IGBDdWlzaW5lOiAke3Jlc3RhdXJhbnQuY3Vpc2luZV90eXBlfWA7XG5cbiAgLy8gZmlsbCBvcGVyYXRpbmcgaG91cnNcbiAgaWYgKHJlc3RhdXJhbnQub3BlcmF0aW5nX2hvdXJzKSB7XG4gICAgZmlsbFJlc3RhdXJhbnRIb3Vyc0hUTUwoKTtcbiAgfVxuICAvLyBmaWxsIHJldmlld3NcbiAgZmlsbFJldmlld3NIVE1MKCk7XG59O1xuXG4vKipcbiAqIENyZWF0ZSByZXN0YXVyYW50IG9wZXJhdGluZyBob3VycyBIVE1MIHRhYmxlIGFuZCBhZGQgaXQgdG8gdGhlIHdlYnBhZ2UuXG4gKi9cbmNvbnN0IGZpbGxSZXN0YXVyYW50SG91cnNIVE1MID0gKG9wZXJhdGluZ0hvdXJzID0gc2VsZi5yZXN0YXVyYW50Lm9wZXJhdGluZ19ob3VycykgPT4ge1xuICBjb25zdCBob3VycyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZXN0YXVyYW50LWhvdXJzJyk7XG4gIGZvciAoY29uc3Qga2V5IGluIG9wZXJhdGluZ0hvdXJzKSB7XG4gICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvcGVyYXRpbmdIb3Vycywga2V5KSkge1xuICAgICAgY29uc3Qgcm93ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndHInKTtcblxuICAgICAgY29uc3QgZGF5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGQnKTtcbiAgICAgIGRheS5pbm5lckhUTUwgPSBrZXk7XG4gICAgICByb3cuYXBwZW5kQ2hpbGQoZGF5KTtcblxuICAgICAgY29uc3QgdGltZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RkJyk7XG4gICAgICB0aW1lLmlubmVySFRNTCA9IG9wZXJhdGluZ0hvdXJzW2tleV07XG4gICAgICByb3cuYXBwZW5kQ2hpbGQodGltZSk7XG5cbiAgICAgIGhvdXJzLmFwcGVuZENoaWxkKHJvdyk7XG4gICAgfVxuICB9XG59O1xuXG4vKipcbiAqIENyZWF0ZSBhbGwgcmV2aWV3cyBIVE1MIGFuZCBhZGQgdGhlbSB0byB0aGUgd2VicGFnZS5cbiAqL1xuY29uc3QgZmlsbFJldmlld3NIVE1MID0gKHJldmlld3MgPSBzZWxmLnJlc3RhdXJhbnQucmV2aWV3cykgPT4ge1xuICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmV2aWV3cy1jb250YWluZXInKTtcbiAgY29uc3QgdGl0bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdoMicpO1xuICB0aXRsZS5pbm5lckhUTUwgPSAnUmV2aWV3cyc7XG4gIGNvbnRhaW5lci5hcHBlbmRDaGlsZCh0aXRsZSk7XG5cbiAgaWYgKCFyZXZpZXdzKSB7XG4gICAgY29uc3Qgbm9SZXZpZXdzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xuICAgIG5vUmV2aWV3cy5pbm5lckhUTUwgPSAnTm8gcmV2aWV3cyB5ZXQhJztcbiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQobm9SZXZpZXdzKTtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgdWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmV2aWV3cy1saXN0Jyk7XG4gIHJldmlld3MuZm9yRWFjaCgocmV2aWV3KSA9PiB7XG4gICAgdWwuYXBwZW5kQ2hpbGQoY3JlYXRlUmV2aWV3SFRNTChyZXZpZXcpKTtcbiAgfSk7XG4gIGNvbnRhaW5lci5hcHBlbmRDaGlsZCh1bCk7XG59O1xuXG4vKipcbiAqIENyZWF0ZSByZXZpZXcgSFRNTCBhbmQgYWRkIGl0IHRvIHRoZSB3ZWJwYWdlLlxuICovXG5jb25zdCBjcmVhdGVSZXZpZXdIVE1MID0gKHJldmlldykgPT4ge1xuICBjb25zdCBhcnRpY2xlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYXJ0aWNsZScpO1xuICBhcnRpY2xlLmNsYXNzTmFtZSA9ICdyZXZpZXcnO1xuXG4gIGNvbnN0IGhlYWRlclNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XG4gIGhlYWRlclNwYW4uY2xhc3NOYW1lID0gJ3Jldmlldy1oZWFkZXInO1xuXG4gIGNvbnN0IG5hbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XG4gIG5hbWUuaW5uZXJIVE1MID0gcmV2aWV3Lm5hbWU7XG4gIG5hbWUuY2xhc3NOYW1lID0gJ3Jldmlldy1uYW1lJztcbiAgaGVhZGVyU3Bhbi5hcHBlbmRDaGlsZChuYW1lKTtcblxuICBjb25zdCBkYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xuICBkYXRlLmlubmVySFRNTCA9IHJldmlldy5kYXRlO1xuICBkYXRlLmNsYXNzTmFtZSA9ICdyZXZpZXctZGF0ZSc7XG4gIGhlYWRlclNwYW4uYXBwZW5kQ2hpbGQoZGF0ZSk7XG4gIGFydGljbGUuYXBwZW5kQ2hpbGQoaGVhZGVyU3Bhbik7XG5cbiAgY29uc3QgY29udGVudFNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XG4gIGNvbnRlbnRTcGFuLmNsYXNzTmFtZSA9ICdyZXZpZXctY29udGVudCc7XG5cbiAgY29uc3QgcmF0aW5nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xuICByYXRpbmcuaW5uZXJIVE1MID0gYFJhdGluZzogJHtyZXZpZXcucmF0aW5nfWA7XG4gIHJhdGluZy5jbGFzc05hbWUgPSAncmV2aWV3LXJhdGluZyc7XG4gIGNvbnRlbnRTcGFuLmFwcGVuZENoaWxkKHJhdGluZyk7XG5cbiAgY29uc3QgY29tbWVudHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XG4gIGNvbW1lbnRzLmlubmVySFRNTCA9IHJldmlldy5jb21tZW50cztcbiAgY29udGVudFNwYW4uYXBwZW5kQ2hpbGQoY29tbWVudHMpO1xuICBhcnRpY2xlLmFwcGVuZENoaWxkKGNvbnRlbnRTcGFuKTtcblxuICByZXR1cm4gYXJ0aWNsZTtcbn07XG5cbi8qKlxuICogQWRkIHJlc3RhdXJhbnQgbmFtZSB0byB0aGUgYnJlYWRjcnVtYiBuYXZpZ2F0aW9uIG1lbnVcbiAqL1xuY29uc3QgZmlsbEJyZWFkY3J1bWIgPSAocmVzdGF1cmFudCA9IHNlbGYucmVzdGF1cmFudCkgPT4ge1xuICBjb25zdCBicmVhZGNydW1iID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2JyZWFkY3J1bWInKTtcbiAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpO1xuICBsaS5pbm5lckhUTUwgPSByZXN0YXVyYW50Lm5hbWU7XG4gIGJyZWFkY3J1bWIuYXBwZW5kQ2hpbGQobGkpO1xufTtcblxuLyoqXG4gKiBHZXQgYSBwYXJhbWV0ZXIgYnkgbmFtZSBmcm9tIHBhZ2UgVVJMLlxuICovXG5jb25zdCBnZXRQYXJhbWV0ZXJCeU5hbWUgPSAobmFtZSwgdXJsKSA9PiB7XG4gIHVybCA9IHVybCB8fCB3aW5kb3cubG9jYXRpb24uaHJlZjtcbiAgbmFtZSA9IG5hbWUucmVwbGFjZSgvW1xcW1xcXV0vZywgJ1xcXFwkJicpO1xuICBjb25zdCByZWdleCA9IG5ldyBSZWdFeHAoYFs/Jl0ke25hbWV9KD0oW14mI10qKXwmfCN8JClgKTtcblxuXG4gIGNvbnN0IHJlc3VsdHMgPSByZWdleC5leGVjKHVybCk7XG4gIGlmICghcmVzdWx0cykgcmV0dXJuIG51bGw7XG4gIGlmICghcmVzdWx0c1syXSkgcmV0dXJuICcnO1xuICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHJlc3VsdHNbMl0ucmVwbGFjZSgvXFwrL2csICcgJykpO1xufTtcblxuY29uc3QgcmVnaXN0ZXJTZXJ2aWNlV29ya2VyID0gKCkgPT4ge1xuICBpZiAoIW5hdmlnYXRvci5zZXJ2aWNlV29ya2VyKSByZXR1cm47XG5cbiAgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIucmVnaXN0ZXIoJy9zZXJ2aWNlLXdvcmtlci5qcycpXG4gICAgLmNhdGNoKGVycm9yID0+IGNvbnNvbGUubG9nKGVycm9yKSk7XG59O1xuIl0sImZpbGUiOiJyZXN0YXVyYW50X2luZm8uanMifQ==
